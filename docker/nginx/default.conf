# ╔════════════════════════════════════════════════════════════════╗
# ║  CONFIGURATION NGINX - EXPLIQUÉE LIGNE PAR LIGNE               ║
# ╚════════════════════════════════════════════════════════════════╝


# ============================================
# BLOC SERVER
# ============================================
# Un bloc "server" = un site web
# Tu peux avoir plusieurs blocs server pour plusieurs sites

server {

    # ════════════════════════════════════════
    # listen 80;
    # ════════════════════════════════════════
    # 
    # Sur quel port Nginx écoute les requêtes ?
    # Port 80 = port HTTP standard
    #
    # Quand tu fais localhost:8080, Docker redirige :
    #   ton PC:8080 ──► container:80
    #
    listen 80;


    # ════════════════════════════════════════
    # server_name localhost;
    # ════════════════════════════════════════
    #
    # Quel nom de domaine ce bloc gère ?
    # 
    # En dev     : localhost
    # En prod    : server_name lso-erp.com www.lso-erp.com;
    #
    # Si tu as plusieurs sites :
    #   server { server_name site1.com; ... }
    #   server { server_name site2.com; ... }
    #
    server_name localhost;


    # ════════════════════════════════════════
    # root /var/www/html/public;
    # ════════════════════════════════════════
    #
    # Où sont les fichiers du site ?
    # 
    # IMPORTANT pour Laravel :
    #   - Le code est dans /var/www/html/
    #   - Mais le point d'entrée est /var/www/html/public/
    #   - C'est là qu'est index.php
    #
    # Structure Laravel :
    #   /var/www/html/
    #   ├── app/
    #   ├── config/
    #   ├── public/          ← ROOT pointe ici
    #   │   ├── index.php    ← Point d'entrée
    #   │   ├── css/
    #   │   └── js/
    #   └── ...
    #
    # Sécurité : on expose SEULEMENT /public
    #            Les fichiers .env, config/ etc. sont inaccessibles
    #
    root /var/www/html/public;


    # ════════════════════════════════════════
    # index index.php index.html;
    # ════════════════════════════════════════
    #
    # Si on demande un dossier, quel fichier servir ?
    #
    # localhost/ → cherche index.php, sinon index.html
    #
    index index.php index.html;


    # ════════════════════════════════════════
    # error_log / access_log
    # ════════════════════════════════════════
    #
    # Où écrire les logs ?
    #
    # error_log  : Les erreurs (404, 500, etc.)
    # access_log : Toutes les requêtes reçues
    #
    # Utile pour débugger :
    #   docker compose logs nginx
    #
    error_log  /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;


    # ════════════════════════════════════════
    # location / { ... }
    # ════════════════════════════════════════
    #
    # Comment traiter les requêtes vers "/" (la racine) ?
    #
    # try_files expliqué :
    #   $uri        → Essaie de trouver le fichier exact
    #   $uri/       → Essaie comme dossier
    #   /index.php  → Sinon, passe tout à index.php
    #
    # Exemple : localhost/about
    #   1. Cherche /public/about      (fichier) → Non
    #   2. Cherche /public/about/     (dossier) → Non
    #   3. Envoie à /index.php?/about → Laravel gère la route
    #
    # C'est ce qui permet à Laravel de gérer les "jolies URLs"
    # comme /users/1 au lieu de /index.php?controller=users&id=1
    #
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }


    # ════════════════════════════════════════
    # location ~ \.php$ { ... }
    # ════════════════════════════════════════
    #
    # Comment traiter les fichiers .php ?
    #
    # Le "~" signifie : utilise une expression régulière
    # "\.php$" signifie : tout fichier qui finit par .php
    #
    location ~ \.php$ {
    
        # Vérifie que le fichier existe, sinon erreur 404
        try_files $uri =404;
        
        # Sépare le chemin du fichier et les infos supplémentaires
        # /index.php/some/path → fichier: /index.php, path_info: /some/path
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        
        # ════════════════════════════════════
        # fastcgi_pass app:9000;
        # ════════════════════════════════════
        #
        # TRÈS IMPORTANT !
        #
        # "app" = le nom du service PHP dans docker-compose.yml
        # "9000" = le port sur lequel PHP-FPM écoute
        #
        # Nginx dit : "Hé app, exécute ce PHP et donne-moi le résultat"
        #
        # Comment ça marche :
        #   - Docker crée un réseau interne
        #   - Les containers se parlent par leur nom
        #   - "app" est résolu vers l'IP du container PHP
        #
        fastcgi_pass app:9000;
        
        # Fichier par défaut si on demande un dossier
        fastcgi_index index.php;
        
        # Charge les paramètres FastCGI standards
        include fastcgi_params;
        
        # Dit à PHP quel fichier exécuter
        # $document_root = /var/www/html/public
        # $fastcgi_script_name = /index.php
        # Résultat : /var/www/html/public/index.php
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }


    # ════════════════════════════════════════
    # location ~ /\.(?!well-known).* { ... }
    # ════════════════════════════════════════
    #
    # Bloque l'accès aux fichiers cachés (commençant par .)
    #
    # Bloqués :
    #   /.env           → Tes secrets !
    #   /.git           → Ton historique Git
    #   /.htaccess      → Config Apache
    #
    # Exception : /.well-known/ 
    #   → Nécessaire pour les certificats SSL (Let's Encrypt)
    #
    # "deny all" = retourne erreur 403 Forbidden
    #
    location ~ /\.(?!well-known).* {
        deny all;
    }

}


# ╔════════════════════════════════════════════════════════════════╗
# ║  RÉSUMÉ VISUEL                                                 ║
# ╚════════════════════════════════════════════════════════════════╝
#
#   Requête : localhost:8080/api/tasks
#
#   ┌─────────────────────────────────────────────────────────────┐
#   │                                                             │
#   │  1. Nginx reçoit sur port 80                                │
#   │                     │                                       │
#   │                     ▼                                       │
#   │  2. location / → try_files                                  │
#   │     - /public/api/tasks existe ? Non                        │
#   │     - /public/api/tasks/ existe ? Non                       │
#   │     - → Envoie à /index.php                                 │
#   │                     │                                       │
#   │                     ▼                                       │
#   │  3. location ~ \.php$ → fastcgi_pass app:9000               │
#   │     - Envoie à PHP-FPM                                      │
#   │                     │                                       │
#   │                     ▼                                       │
#   │  4. PHP-FPM exécute Laravel                                 │
#   │     - Laravel route vers TaskController                     │
#   │     - Retourne JSON                                         │
#   │                     │                                       │
#   │                     ▼                                       │
#   │  5. Nginx renvoie la réponse au navigateur                  │
#   │                                                             │
#   └─────────────────────────────────────────────────────────────┘
